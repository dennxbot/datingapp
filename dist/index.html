<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💕 Dating App - Find Your Match</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/socket.io-client@4.7.2/dist/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100">
    <div id="app"></div>
    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        
        // Socket connection
        let socket = null;
        
        function initSocket() {
            socket = io();
            return socket;
        }
        
        // Chat Screen Component
        const ChatScreen = {
            props: {
                partnerUsername: String,
                currentUsername: String,
                isPartnerOnline: Boolean,
                isPartnerTyping: Boolean,
                messages: Array
            },
            emits: ['send-message', 'find-new-match', 'add-reaction', 'edit-message', 'typing'],
            setup(props, { emit }) {
                const messageText = ref('');
                const replyingTo = ref(null);
                const messagesContainer = ref(null);
                
                const handleSendMessage = () => {
                    if (!messageText.value.trim()) return;
                    
                    const messageData = {
                        message: messageText.value.trim()
                    };
                    
                    if (replyingTo.value) {
                        messageData.replyTo = replyingTo.value;
                        cancelReply();
                    }
                    
                    emit('send-message', messageData);
                    messageText.value = '';
                };
                
                const handleReply = (message) => {
                    replyingTo.value = message;
                };
                
                const cancelReply = () => {
                    replyingTo.value = null;
                };
                
                // Auto-scroll to bottom when new messages arrive
                watch(() => props.messages, async () => {
                    await nextTick();
                    if (messagesContainer.value) {
                        messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight;
                    }
                }, { deep: true });
                
                return {
                    messageText,
                    replyingTo,
                    messagesContainer,
                    handleSendMessage,
                    handleReply,
                    cancelReply
                };
            },
            methods: {
                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                },
                showContextMenu(event, message) {
                    event.preventDefault();
                    // Simple reply functionality - just set replyingTo
                    this.handleReply(message);
                }
            },
            template: `
                <div class="min-h-screen flex flex-col bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100">
                    <!-- Header -->
                    <div class="glass-effect sticky top-0 z-10 px-4 py-4 border-b border-white/20">
                        <div class="flex items-center justify-between max-w-4xl mx-auto">
                            <div class="flex items-center space-x-4">
                                <div class="text-2xl">💬</div>
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-800">
                                        Chat with <span class="text-purple-600">{{ partnerUsername }}</span>
                                    </h2>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center text-xs font-medium px-2 py-1 rounded-full"
                                              :class="isPartnerOnline ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                                            <span class="w-2 h-2 rounded-full mr-1" :class="isPartnerOnline ? 'bg-green-400' : 'bg-red-400'"></span>
                                            {{ isPartnerOnline ? 'Online' : 'Offline' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <button @click="$emit('find-new-match')" class="btn-secondary text-sm py-2 px-4">
                                🔄 Find New Match
                            </button>
                        </div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div ref="messagesContainer" class="flex-1 px-4 py-6 overflow-y-auto">
                        <div class="max-w-4xl mx-auto space-y-4">
                            <!-- Welcome Message -->
                            <div class="text-center py-8">
                                <div class="glass-effect rounded-xl p-6 inline-block">
                                    <div class="text-3xl mb-2">🎉</div>
                                    <p class="text-gray-700 font-medium">You've been matched! Say hello!</p>
                                </div>
                            </div>
                            
                            <!-- Messages -->
                            <div v-for="message in messages" :key="message.id" class="group"
                                 :class="message.isOwn ? 'flex justify-end' : 'flex justify-start'">
                                <div class="relative max-w-xs md:max-w-md lg:max-w-lg"
                                     :class="message.isOwn ? 'order-2' : 'order-1'">
                                    <!-- Reply Info -->
                                    <div v-if="message.replyTo" 
                                         class="mb-2 px-3 py-2 rounded-lg bg-gray-100/70 border-l-4 border-purple-400 text-sm">
                                        <div class="font-medium text-purple-600 text-xs mb-1">
                                            Replying to {{ message.replyTo.username }}
                                        </div>
                                        <div class="text-gray-600 truncate">
                                            {{ message.replyTo.text }}
                                        </div>
                                    </div>
                                    
                                    <!-- Message Bubble -->
                                    <div class="relative px-4 py-3 rounded-2xl shadow-md transition-all duration-300 group-hover:shadow-lg cursor-pointer"
                                         :class="message.isOwn ? 
                                           'bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-br-md' : 
                                           'glass-effect text-gray-800 rounded-bl-md'"
                                         @contextmenu.prevent="(e) => showContextMenu(e, message)">
                                        <p class="break-words">{{ message.text }}</p>
                                        <div class="flex items-center justify-between mt-2 text-xs opacity-75">
                                            <span>{{ message.isOwn ? 'You' : message.username }}</span>
                                            <span>{{ formatTime(message.timestamp) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reply Banner -->
                    <div v-if="replyingTo" 
                         class="bg-purple-100 border-2 border-purple-300 shadow-xl px-4 py-4 transition-all duration-300">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <div class="text-purple-600 text-2xl font-bold bg-white rounded-full w-10 h-10 flex items-center justify-center shadow-md">↩️</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-base font-bold text-purple-800 mb-2">
                                            Replying to {{ replyingTo.isOwn ? 'yourself' : (replyingTo.username || 'User') }}
                                        </div>
                                        <div class="text-sm text-gray-800 bg-white px-3 py-2 rounded-lg border-l-4 border-purple-500 shadow-sm">
                                            {{ replyingTo.text }}
                                        </div>
                                    </div>
                                </div>
                                <button @click="cancelReply"
                                        class="flex-shrink-0 w-12 h-12 rounded-full bg-red-500 hover:bg-red-600 transition-all duration-200 flex items-center justify-center text-white font-bold text-xl shadow-lg hover:shadow-xl transform hover:scale-105"
                                        title="Cancel reply">
                                    ✕
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="glass-effect border-t border-white/20 px-4 py-4">
                        <div class="max-w-4xl mx-auto">
                            <form @submit.prevent="handleSendMessage" class="flex items-end space-x-4">
                                <div class="flex-1">
                                    <textarea v-model="messageText"
                                             @input="$emit('typing')"
                                             @keypress.enter.exact.prevent="handleSendMessage"
                                             placeholder="Type your message..."
                                             rows="1"
                                             maxlength="500"
                                             class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:outline-none transition-all duration-300 bg-white/70 backdrop-blur-sm resize-none"
                                             style="max-height: 120px; min-height: 48px;"></textarea>
                                    <div class="flex justify-between items-center mt-2 px-2">
                                        <span class="text-xs text-gray-500">Press Enter to send, Right-click message to reply</span>
                                        <span class="text-xs text-gray-500">{{ messageText.length }}/500</span>
                                    </div>
                                </div>
                                
                                <button type="submit"
                                        :disabled="!messageText.trim()"
                                        class="btn-gradient disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none px-6 py-3">
                                    <span class="text-lg">🚀</span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `
        };
        
        // Main App
        const app = createApp({
            components: {
                ChatScreen
            },
            setup() {
                const currentView = ref('login');
                const currentUsername = ref('');
                const partnerUsername = ref('');
                const isPartnerOnline = ref(false);
                const isPartnerTyping = ref(false);
                const messages = ref([]);
                let typingTimeout = null;
                
                const initializeSocket = () => {
                    socket = initSocket();
                    
                    socket.on('username_error', (data) => {
                        console.error('Username error:', data.error);
                        currentView.value = 'login';
                    });
                    
                    socket.on('waiting', () => {
                        currentView.value = 'waiting';
                    });
                    
                    socket.on('matched', (data) => {
                        partnerUsername.value = data.partnerUsername;
                        currentView.value = 'chat';
                        messages.value = [];
                    });
                    
                    socket.on('partner_left', () => {
                        currentView.value = 'partner_left';
                        isPartnerOnline.value = false;
                    });
                    
                    socket.on('partner_status', (data) => {
                        isPartnerOnline.value = data.online;
                    });
                    
                    socket.on('new_message', (messageData) => {
                        messages.value.push({
                            id: messageData.messageId,
                            text: messageData.message,
                            username: messageData.username,
                            timestamp: messageData.timestamp,
                            isOwn: messageData.username === currentUsername.value,
                            replyTo: messageData.replyTo || null
                        });
                    });
                    
                    socket.on('partner_typing', (data) => {
                        isPartnerTyping.value = data.typing;
                    });
                };
                
                const handleJoin = (username) => {
                    currentUsername.value = username;
                    initializeSocket();
                    socket.emit('join', { username });
                };
                
                const handleSendMessage = (messageData) => {
                    if (socket && socket.connected) {
                        socket.emit('send_message', messageData);
                    }
                };
                
                const handleFindNewMatch = () => {
                    if (socket && socket.connected) {
                        socket.emit('find_new_match');
                    }
                    currentView.value = 'waiting';
                };
                
                const handleTyping = () => {
                    if (socket && socket.connected) {
                        socket.emit('typing');
                        
                        clearTimeout(typingTimeout);
                        typingTimeout = setTimeout(() => {
                            socket.emit('stop_typing');
                        }, 1000);
                    }
                };
                
                return {
                    currentView,
                    currentUsername,
                    partnerUsername,
                    isPartnerOnline,
                    isPartnerTyping,
                    messages,
                    handleJoin,
                    handleSendMessage,
                    handleFindNewMatch,
                    handleTyping
                };
            },
            template: `
                <div>
                    <div v-if="currentView === 'login'" class="min-h-screen flex items-center justify-center">
                        <div class="glass-effect rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">💕</div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-2">Dating App</h1>
                                <p class="text-gray-600">Find your perfect match!</p>
                            </div>
                            <div class="space-y-6">
                                <input ref="usernameInput" type="text" placeholder="Enter username" 
                                       class="w-full px-4 py-3 rounded-xl border border-purple-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:outline-none transition-all duration-300 bg-white/70 backdrop-blur-sm"
                                       @keypress.enter="handleJoin($event.target.value)">
                                <button class="btn-gradient w-full text-white py-3 px-6 rounded-xl font-semibold" 
                                        @click="handleJoin($refs.usernameInput.value || 'TestUser')">🚀 Find My Match</button>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else-if="currentView === 'waiting'" class="min-h-screen flex items-center justify-center">
                        <div class="glass-effect rounded-2xl shadow-2xl p-8 text-center max-w-md">
                            <div class="text-6xl mb-6 animate-pulse">💫</div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Looking for your match...</h2>
                            <p class="text-gray-600 mb-6">We're searching for someone special for you.</p>
                            <div class="flex justify-center space-x-2 mb-6">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else-if="currentView === 'partner_left'" class="min-h-screen flex items-center justify-center">
                        <div class="glass-effect rounded-2xl shadow-2xl p-8 text-center max-w-md">
                            <div class="text-6xl mb-6">😔</div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Partner Disconnected</h2>
                            <p class="text-gray-600 mb-6">Your chat partner has left. Don't worry, there are more matches!</p>
                            <button @click="handleFindNewMatch" class="btn-gradient text-white py-3 px-6 rounded-xl font-semibold">
                                💕 Find New Match
                            </button>
                        </div>
                    </div>
                    
                    <ChatScreen v-else-if="currentView === 'chat'"
                                :partner-username="partnerUsername"
                                :current-username="currentUsername"
                                :is-partner-online="isPartnerOnline"
                                :is-partner-typing="isPartnerTyping"
                                :messages="messages"
                                @send-message="handleSendMessage"
                                @find-new-match="handleFindNewMatch"
                                @typing="handleTyping" />
                </div>
            `
        });
        
        app.mount('#app');
    </script>
</body>
</html>
